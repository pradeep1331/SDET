WITH grouped_data AS (
    SELECT 
        LOC_PAL.WHSE_ID,
        LOC_PAL.BLDG_ID,
        LOC_PAL.LOC_ID,
        PALLET_DTL.SKU,
        PALLET_DTL.LOT_NO1,
        PALLET_DTL.EXPIRY_DATE,
        LISTAGG(PHD.hold_reason_cd, ',') WITHIN GROUP (ORDER BY PHD.hold_reason_cd) AS lock_codes,  -- Assuming PHD alias
        SUM(PALLET_DTL.ONHAND_QTY) AS TOTAL_ONHAND_QTY,
        COUNT(DISTINCT PALLET_DTL.SKU) OVER (PARTITION BY LOC_PAL.WHSE_ID, LOC_PAL.BLDG_ID, LOC_PAL.LOC_ID) AS SKU_COUNT
    FROM LOC_PAL
    JOIN PALLET_HDR ON LOC_PAL.WHSE_ID = PALLET_HDR.WHSE_ID AND LOC_PAL.BLDG_ID = PALLET_HDR.BLDG_ID AND LOC_PAL.PALLET_ID = PALLET_HDR.PALLET_ID
    JOIN PALLET_DTL ON LOC_PAL.WHSE_ID = PALLET_DTL.WHSE_ID AND LOC_PAL.BLDG_ID = PALLET_DTL.BLDG_ID AND LOC_PAL.PALLET_ID = PALLET_DTL.PALLET_ID
    LEFT OUTER JOIN (
        SELECT 
            whse_id,
            bldg_id,
            pallet_id,
            hold_reason_cd
        FROM pallet_hold_dtl
    ) PHD ON LOC_PAL.WHSE_ID = PHD.WHSE_ID AND LOC_PAL.BLDG_ID = PHD.BLDG_ID AND LOC_PAL.PALLET_ID = PHD.PALLET_ID
    WHERE LOC_PAL.WHSE_ID = 'HCNA'
        AND PALLET_DTL.ONHAND_QTY > 0
        AND LOC_ID <> 'RCV'
    GROUP BY
        LOC_PAL.WHSE_ID,
        LOC_PAL.BLDG_ID,
        LOC_PAL.LOC_ID,
        PALLET_DTL.SKU,
        PALLET_DTL.LOT_NO1,
        PALLET_DTL.EXPIRY_DATE
)
SELECT * FROM grouped_data
WHERE SKU_COUNT > 1



SELECT
  inv_transaction.*,
  sku_profile.SKU_DESC,
  CASE WHEN inv_transactions.REF_TYPE3 = 'ORD_GRP_NO' THEN inv_transactions.REF_NO3 ELSE '' END AS ORDER_NBR,
  CASE WHEN inv_transactions.REF_TYPE2 = 'PO_NO' THEN inv_transactions.REF_NO2 ELSE '' END AS Inbound_reference,
  COALESCE(order_header.EXT_ORD_NO, '') AS EXT_ORD_NO
FROM inv_transaction
INNER JOIN sku_profile
  ON inv_transaction.WHSE_ID = sku_profile.WHSE_ID
  AND inv_transaction.BLDG_ID = sku_profile.BLDG_ID
  AND inv_transaction.SKU = sku_profile.SKU
LEFT JOIN order_header
  ON inv_transaction.WHSE_ID = order_header.WHSE_ID
  AND inv_transaction.BLDG_ID = order_header.BLDG_ID
  AND inv_transaction.REF_NO3 = order_header.ORD_NO;
